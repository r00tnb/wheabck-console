<?php
//global: $shost, $sport, $type, $rhost, $rport
$ret = array('code'=>-1, 'msg'=>'');
if(($sock=stream_socket_client("udp://[$shost]:$sport", $errno, $errstr))!==false){
    $buf = pack('CCn', 1, $type, $type == 4?6:18);
    stream_socket_sendto($sock, $buf);
    stream_socket_sendto($sock, inet_pton($rhost).pack('n', $rport));
    if(($recvbuf = stream_socket_recvfrom($sock, 3))!==false){
        $code = unpack('C', substr($recvbuf, 0, 1))[1];
        if($code == 0){
            if(($recvbuf = stream_socket_recvfrom($sock, 1))!==false){
                $ret['code'] = 1;
                $ret['msg'] = unpack('C', $recvbuf)[1];
            }
        }else{
            $ret['code'] = -2;
            $ret['msg'] = $code;
        }
    }
}
if($ret['code'] === -1){
    $ret['msg'] = base64_encode(socket_strerror(socket_last_error()));
}
echo json_encode($ret);