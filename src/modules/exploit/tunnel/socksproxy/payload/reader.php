<?php
//global: $sockid, $shost, $sport
set_time_limit(0);
$ret = array('code'=>-1, 'msg'=>'');
if(($sock = socket_create(AF_INET, SOCK_DGRAM, SOL_UDP))!==false){
    $buf = pack('CCn', 2, $sockid, 0);
    if(socket_sendto($sock, $buf, strlen($buf), 0, $shost, $sport)!==false){
        if(socket_recvfrom($sock, $recvbuf, 3, 0, $shost, $sport)!==false){
            $code = unpack('C', substr($recvbuf, 0, 1))[1];
            $length = unpack('n', substr($recvbuf, 1, 2))[1];
            if($code == 0){
                if(socket_recvfrom($sock, $recvbuf, $length, 0, $shost, $sport)!==false){
                    $ret['code'] = 1;
                    $ret['msg'] = base64_encode($recvbuf);
                }
            }else{
                $ret['code'] = -2;//连接被关闭
                $ret['msg'] = $code;
            }
        }
    }
}
if($ret['code'] === -1){
    $ret['msg'] = base64_encode(socket_strerror(socket_last_error()));
}
echo json_encode($ret);