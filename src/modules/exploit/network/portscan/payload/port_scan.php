<?php
//global: $ports, $ip, $isudp, $timeout
$ret = array();
$ports = explode(",", $ports);
foreach($ports as $port){
    $port = intval($port);
    if($isudp){
        $sock = socket_create(AF_INET, SOCK_DGRAM, SOL_UDP);
        socket_set_option($sock,SOL_SOCKET, SO_RCVTIMEO, array("sec"=>$timeout/1000, "usec"=>0));
        if(socket_sendto($sock, "123", 3, 0, $ip, $port)!==false && socket_recvfrom($sock, $buf, 1, 0, $ip, $port)!==false) $ret[] = $port;
        socket_close($sock);
    }else{
        $res = fsockopen($ip, $port, $errno, $errstr, 2);
        if($res !== false){
            $ret[] = $port;
            fclose($res);
        }
    }
}
echo json_encode($ret);