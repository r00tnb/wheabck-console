<?php
//global: $host, $port, $user, $password, $database, $sql
$ret = array('code'=>-2, 'msg'=>'', 'affected'=>0, 'result'=>array());
if(function_exists('sqlsrv_connect')){
    $server = "{$host}, {$port}";
    $connectinfo = array(
        "UID"=>$user, 
        "PWD"=>$password,
        "Database"=>$database
    );
    $conn = @sqlsrv_connect($server, $connectinfo);
    if(!$conn){
        $ret['code'] = -1;
        $ret['msg'] = 'Connect failed: '.print_r(sqlsrv_errors(), true);
        $ret['msg'] = base64_encode($ret['msg']);
    }else{
        $r = @sqlsrv_query($conn, $sql);
        if($r === false){
            $ret['code'] = 0;
            $ret['msg'] = 'Query failed: '.print_r(sqlsrv_errors(), true);
            $ret['msg'] = base64_encode($ret['msg']);
        }elseif (!sqlsrv_num_fields($r)){
            $ret['code'] = 2;
            $ret['affected'] = sqlsrv_rows_affected($r);
        }else{
            $columns = array();
            if($fields = sqlsrv_fetch_fields($r)){
                foreach($fields as $field){
                    $columns[] = base64_encode($field->name);
                }
                $ret['result'][] = $columns;
            }
            while($row=sqlsrv_fetch_array($r, SQLSRV_FETCH_ASSOC)){
                $tmp = array();
                foreach($row as $key=>$val){
                    $tmp[] = base64_encode($val);
                }
                $ret['result'][] = $tmp;
            }
            $ret['code'] = 1;
            sqlsrv_free_stmt($r);
        }
        sqlsrv_close($conn);
    }
}
echo json_encode($ret);