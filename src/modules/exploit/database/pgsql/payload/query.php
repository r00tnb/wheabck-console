<?php
$ret = array('code'=>-2, 'msg'=>'');
if(function_exists('pg_connect')){
    $des = "host={$host} port={$port} dbname={$database} user={$user} password={$password}";
    $conn = @pg_connect($des);
    if(!$conn){
        $ret['code'] = -1;
        $ret['msg'] = 'Connect failed: '.pg_errormessage($conn);
        $ret['msg'] = base64_encode($ret['msg']);
    }else{
        $r = pg_query($conn, $sql);
        if($r === false){
            $ret['code'] = 0;
            $ret['msg'] = 'Query failed: '.pg_last_error($conn);
            $ret['msg'] = base64_encode($ret['msg']);
        }else{
            $b = pg_num_fields($r);
            if($b==-1 || $b==0){
                $ret['code'] = 2;
                $ret['affected'] = pg_affected_rows($r);
            }else{
                $ret['result'] = array();
                while($row=pg_fetch_assoc($r)){
                    $tmp = array();
                    foreach($row as $key=>$val){
                        $tmp[base64_encode($key)] = base64_encode($val);
                    }
                    $ret['result'][] = $tmp;
                }
                $ret['code'] = 1;
                pg_free_result($r);
            }
        }
        @pg_close($conn);
    }
}
echo json_encode($ret);